<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>EMG Traffic Plan Designer</title>

        <!-- Parsers -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        
        <style>
            /* Modern, Industrial Design System */
            :root {
                --primary: #ff6b35;
                --primary-dark: #e04e1f;
                --secondary: #004e89;
                --accent: #f7b801;
                --success: #06d6a0;
                --danger: #ef476f;
                --bg-main: #0a0e27;
                --bg-card: #151934;
                --bg-hover: #1e2447;
                --text-primary: #e8eaed;
                --text-secondary: #9aa0a6;
                --border: #2d3356;
                --shadow: 0 4px 20px rgba(0,0,0,0.4);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', system-ui, sans-serif;
                background: linear-gradient(135deg, var(--bg-main) 0%, #1a1f3a 100%);
                color: var(--text-primary);
                min-height: 100vh;
                overflow-x: hidden;
            }

            .container {
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            .header {
                background: var(--bg-card);
                padding: 1.5rem 2rem;
                border-bottom: 2px solid var(--primary);
                box-shadow: var(--shadow);
                position: relative;
                overflow: hidden;
            }

            .header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
                animation: shimmer 3s infinite;
            }

            @keyframes shimmer {
                0%, 100% { opacity: 0.5; }
                50% { opacity: 1; }
            }

            .header h1 {
                font-size: 1.75rem;
                font-weight: 700;
                margin-bottom: 0.5rem;
                letter-spacing: -0.02em;
                background: linear-gradient(135deg, var(--primary), var(--accent));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .header p {
                color: var(--text-secondary);
                font-size: 0.95rem;
            }

            .main-grid {
                display: grid;
                grid-template-columns: 320px 1fr;
                flex: 1;
                overflow: hidden;
                gap: 0;
            }

            .sign-library {
                background: var(--bg-card);
                border-right: 1px solid var(--border);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .sign-library h2 {
                padding: 1.25rem 1.5rem;
                font-size: 1.1rem;
                font-weight: 600;
                background: var(--bg-hover);
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            #signTotal {
                color: var(--accent);
                font-weight: 700;
            }

            .search-box {
                padding: 1rem 1.5rem;
                background: var(--bg-main);
                border-bottom: 1px solid var(--border);
            }

            #searchBox {
                width: 100%;
                padding: 0.75rem 1rem;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 0.9rem;
                transition: all 0.2s;
            }

            #searchBox:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
            }

            #signList {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
            }

            #signList::-webkit-scrollbar {
                width: 8px;
            }

            #signList::-webkit-scrollbar-track {
                background: var(--bg-main);
            }

            #signList::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 4px;
            }

            #signList::-webkit-scrollbar-thumb:hover {
                background: var(--primary);
            }

            .sign-item {
                background: var(--bg-hover);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 0.75rem;
                margin-bottom: 0.75rem;
                cursor: grab;
                transition: all 0.2s;
                display: flex;
                gap: 0.75rem;
                align-items: center;
            }

            .sign-item:hover {
                border-color: var(--primary);
                transform: translateX(4px);
                box-shadow: -4px 0 0 var(--primary);
            }

            .sign-item:active {
                cursor: grabbing;
                transform: scale(0.98);
            }

            .sign-item img {
                width: 50px;
                height: 50px;
                object-fit: contain;
                flex-shrink: 0;
                background: white;
                padding: 4px;
                border-radius: 4px;
            }

            .sign-info {
                flex: 1;
                min-width: 0;
            }

            .sign-id {
                font-weight: 600;
                font-size: 0.85rem;
                color: var(--primary);
                margin-bottom: 0.25rem;
            }

            .sign-name {
                font-size: 0.8rem;
                color: var(--text-secondary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .sign-category {
                font-size: 0.7rem;
                color: var(--accent);
                margin-top: 0.25rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .canvas-container {
                display: flex;
                flex-direction: column;
                overflow: hidden;
                background: var(--bg-main);
            }

            .controls {
                padding: 1.25rem 1.5rem;
                background: var(--bg-card);
                border-bottom: 1px solid var(--border);
                display: flex;
                gap: 1rem;
                align-items: center;
                flex-wrap: wrap;
            }

            #planSelect {
                flex: 1;
                min-width: 250px;
                padding: 0.75rem 1rem;
                background: var(--bg-hover);
                border: 1px solid var(--border);
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s;
            }

            #planSelect:hover {
                border-color: var(--primary);
            }

            #planSelect:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
            }

            button {
                padding: 0.75rem 1.5rem;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .btn-save {
                background: var(--success);
                color: white;
            }

            .btn-save:hover {
                background: #05c293;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(6, 214, 160, 0.3);
            }

            .btn-clear {
                background: var(--danger);
                color: white;
            }

            .btn-clear:hover {
                background: #e63462;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(239, 71, 111, 0.3);
            }

            .sign-count {
                padding: 0.75rem 1.25rem;
                background: var(--bg-hover);
                border: 1px solid var(--border);
                border-radius: 8px;
                font-weight: 600;
                color: var(--text-secondary);
            }

            .sign-count span {
                color: var(--accent);
                font-size: 1.1rem;
            }

            #canvas {
                flex: 1;
                position: relative;
                overflow: auto;
                background-size: contain;
                background-position: center;
                background-repeat: no-repeat;
                background-color: #1a1f3a;
            }

            #canvas.drag-over {
                outline: 3px dashed var(--primary);
                outline-offset: -10px;
                background-color: rgba(255, 107, 53, 0.05);
            }

            .empty-canvas {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                color: var(--text-secondary);
                pointer-events: none;
            }

            .placed-sign {
                position: absolute;
                cursor: move;
                z-index: 10;
                transition: transform 0.2s;
            }

            .placed-sign:hover {
                z-index: 100;
            }

            .placed-sign:hover .sign-controls {
                opacity: 1;
            }

            .sign-controls {
                position: absolute;
                top: -35px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 4px;
                opacity: 0;
                transition: opacity 0.2s;
                background: var(--bg-card);
                padding: 4px;
                border-radius: 6px;
                border: 1px solid var(--border);
                box-shadow: var(--shadow);
            }

            .sign-btn {
                width: 28px;
                height: 28px;
                padding: 0;
                border-radius: 4px;
                font-size: 1rem;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--bg-hover);
                color: var(--text-primary);
                border: 1px solid var(--border);
            }

            .btn-rotate {
                background: var(--secondary);
                color: white;
            }

            .btn-rotate:hover {
                background: #00365f;
            }

            .btn-remove {
                background: var(--danger);
                color: white;
            }

            .btn-remove:hover {
                background: #e63462;
            }

            .placed-sign img {
                width: 70px;
                height: 70px;
                object-fit: contain;
                background: white;
                padding: 6px;
                border-radius: 6px;
                border: 2px solid var(--primary);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .sign-label {
                position: absolute;
                bottom: -24px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--bg-card);
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 0.7rem;
                font-weight: 600;
                white-space: nowrap;
                border: 1px solid var(--border);
                color: var(--primary);
            }

            .loading {
                padding: 3rem;
                text-align: center;
                color: var(--text-secondary);
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 3px solid var(--border);
                border-top-color: var(--primary);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                margin: 0 auto 1rem;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-left: 4px solid var(--primary);
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: var(--shadow);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 400px;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            .notification.success {
                border-left-color: var(--success);
            }

            .notification.error {
                border-left-color: var(--danger);
            }

            /* Responsive Design */
            @media (max-width: 1024px) {
                .main-grid {
                    grid-template-columns: 280px 1fr;
                }
            }

            @media (max-width: 768px) {
                .main-grid {
                    grid-template-columns: 1fr;
                    grid-template-rows: 40vh 1fr;
                }
                
                .sign-library {
                    border-right: none;
                    border-bottom: 1px solid var(--border);
                }

                .controls {
                    flex-direction: column;
                    align-items: stretch;
                }

                #planSelect {
                    min-width: 0;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üöß EMG Traffic Plan Designer</h1>
                <p>Select a traffic plan layout and drag signs to create your custom traffic control plan</p>
            </div>

            <div class="main-grid">
                <div class="sign-library">
                    <h2>üìã Sign Library (<span id="signTotal">0</span>)</h2>
                    <div class="search-box">
                        <input id="searchBox" placeholder="üîç Search signs..." />
                    </div>
                    <div id="signList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading signs...
                        </div>
                    </div>
                </div>

                <div class="canvas-container">
                    <div class="controls">
                        <select id="planSelect">
                            <option value="">Select Traffic Plan Layout...</option>
                        </select>

                        <button class="btn-save" onclick="savePlan()">üíæ Save Plan</button>
                        <button class="btn-clear" onclick="clearAll()">üóëÔ∏è Clear All</button>

                        <div class="sign-count"><span id="signCount">0</span> signs placed</div>
                    </div>

                    <div id="canvas">
                        <div class="empty-canvas">
                            <p style="font-size:17px;font-weight:600">üëà Select a traffic plan above</p>
                            <p style="font-size:13px;margin-top:8px">Then drag signs from the library</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <script>
        /* ---------------------------
        Google Sheets Configuration
        --------------------------- */
        const GOOGLE_SHEET_ID = '11tHHhooqQ7tE1sbXQA_hVZKk2WIOoTqGQqQnqwF2kxI';
        const SIGNS_SHEET = 'Signs';
        const LAYOUTS_SHEET = 'Typical Layout Library';

        /* ---------------------------
        Application State
        --------------------------- */
        let placedSigns = [];
        let draggedSign = null;
        let allSigns = [];
        let allLayouts = [];
        let currentPlanImageUrl = null;

        /* ---------------------------
        URL Parameter Handling for AppSheet Integration
        --------------------------- */
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                planPhoto: params.get('planPhoto') || params.get('plan_photo') || params.get('image'),
                layoutId: params.get('layoutId') || params.get('layout_id') || params.get('id'),
                layoutTitle: params.get('layoutTitle') || params.get('title')
            };
        }

        /* ---------------------------
        Notification System
        --------------------------- */
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        /* ---------------------------
        Google Drive Image Helpers
        --------------------------- */
        function getDriveImageUrl(fileId) {
            if (!fileId) return null;
            return `https://drive.google.com/uc?export=view&id=${fileId}`;
        }

        function extractDriveFileId(url) {
            if (!url) return null;
            url = url.toString().trim();

            const patterns = [
                /\/d\/([a-zA-Z0-9_-]+)/,
                /id=([a-zA-Z0-9_-]+)/,
                /open\?id=([a-zA-Z0-9_-]+)/,
                /uc\?export=view&id=([a-zA-Z0-9_-]+)/
            ];

            for (const p of patterns) {
                const m = url.match(p);
                if (m && m[1]) return m[1];
            }

            const fallback = url.match(/([a-zA-Z0-9_-]{20,})/);
            return fallback ? fallback[1] : null;
        }

        /* ---------------------------
        Data Parsing
        --------------------------- */
        function normalizeKey(k) {
            return k ? k.toString().trim().replace(/\s+/g,'').replace(/_/g,'').toLowerCase() : '';
        }

        function parseSignRows(rows) {
            const signs = [];
            rows.forEach(row => {
                const map = {};
                Object.keys(row).forEach(k => {
                    map[normalizeKey(k)] = row[k];
                });

                const id = map.signid || map.id || map.code;
                const name = map.signname || map.name || map.description;
                const category = map.category || map.type || '';
                const province = map.province || '';
                const fileIdCol = map.drivefileid || map.fileid || map.imagefile;
                const driveLinkCol = map.drivewebviewlink || map.drivewebview || map.webviewlink || map.link;

                if (!id || !name) return;

                let finalId = null;
                if (fileIdCol && fileIdCol.toString().trim() !== '') finalId = fileIdCol.toString().trim();
                else if (driveLinkCol && driveLinkCol.toString().trim() !== '') finalId = extractDriveFileId(driveLinkCol);

                if (!finalId) return;

                signs.push({
                    id: id.toString().trim(),
                    name: name.toString().trim(),
                    category: category ? category.toString().trim() : '',
                    province: province ? province.toString().trim() : '',
                    url: getDriveImageUrl(finalId),
                    fileId: finalId
                });
            });
            return signs;
        }

        function parseLayoutRows(rows) {
            const layouts = [];
            rows.forEach(row => {
                const map = {};
                Object.keys(row).forEach(k => {
                    map[normalizeKey(k)] = row[k];
                });

                const id = map.typicallayoutid || map.id || map.layoutid;
                const title = map.typicallayouttitle || map.title || map.name;
                const roadType = map.roadtype || map.type;
                const planPhoto = map.planphoto || map.photo || map.image;

                if (!id || !title || !planPhoto) return;

                layouts.push({
                    id: id.toString().trim(),
                    title: title.toString().trim(),
                    roadType: roadType ? roadType.toString().trim() : '',
                    imageUrl: planPhoto.toString().trim()
                });
            });
            return layouts;
        }

        /* ---------------------------
        Load Data from Google Sheets
        --------------------------- */
        async function loadFromGoogleSheets() {
            try {
                console.log('Loading data from Google Sheets...');
                
                const signsUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SIGNS_SHEET)}`;
                const signsResponse = await fetch(signsUrl);
                if (signsResponse.ok) {
                    const signsText = await signsResponse.text();
                    Papa.parse(signsText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            allSigns = parseSignRows(results.data);
                            document.getElementById('signTotal').textContent = allSigns.length;
                            loadSignLibrary(allSigns);
                            console.log(`‚úÖ Loaded ${allSigns.length} signs`);
                            showNotification(`Loaded ${allSigns.length} traffic signs`, 'success');
                        }
                    });
                }

                const layoutsUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(LAYOUTS_SHEET)}`;
                const layoutsResponse = await fetch(layoutsUrl);
                if (layoutsResponse.ok) {
                    const layoutsText = await layoutsResponse.text();
                    Papa.parse(layoutsText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            allLayouts = parseLayoutRows(results.data);
                            populateLayoutDropdown(allLayouts);
                            console.log(`‚úÖ Loaded ${allLayouts.length} layouts`);
                            
                            // Check for URL parameters from AppSheet
                            loadPlanFromURL();
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                document.getElementById('signList').innerHTML = `<div class="loading" style="color:#dc2626">‚ö†Ô∏è Error loading data</div>`;
                showNotification('Error loading data from Google Sheets', 'error');
            }
        }

        /* ---------------------------
        Load Plan from URL Parameters (AppSheet Integration)
        --------------------------- */
        function loadPlanFromURL() {
            const params = getURLParams();
            
            // If planPhoto URL is provided directly, use it
            if (params.planPhoto) {
                currentPlanImageUrl = params.planPhoto;
                const canvas = document.getElementById('canvas');
                canvas.style.backgroundImage = `url(${params.planPhoto})`;
                
                const emptyCanvas = canvas.querySelector('.empty-canvas');
                if (emptyCanvas) emptyCanvas.remove();
                
                console.log('Loaded plan from URL:', params.planPhoto);
                showNotification('Traffic plan loaded from AppSheet', 'success');
                
                // If we also have a layout title, show it in the header
                if (params.layoutTitle) {
                    const header = document.querySelector('.header p');
                    header.textContent = `Editing: ${params.layoutTitle}`;
                }
            }
            // Otherwise, try to match by layout ID
            else if (params.layoutId && allLayouts.length > 0) {
                const layout = allLayouts.find(l => l.id === params.layoutId);
                if (layout) {
                    const select = document.getElementById('planSelect');
                    select.value = layout.id;
                    updatePlan();
                    showNotification(`Loaded layout: ${layout.title}`, 'success');
                }
            }
        }

        /* ---------------------------
        Populate Layout Dropdown
        --------------------------- */
        function populateLayoutDropdown(layouts) {
            const select = document.getElementById('planSelect');
            select.innerHTML = '<option value="">Select Traffic Plan Layout...</option>';
            
            if (!layouts || layouts.length === 0) {
                select.innerHTML += '<option disabled>No layouts available</option>';
                return;
            }

            const grouped = {};
            layouts.forEach(layout => {
                const type = layout.roadType || 'Other';
                if (!grouped[type]) grouped[type] = [];
                grouped[type].push(layout);
            });

            Object.keys(grouped).sort().forEach(type => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = type;
                grouped[type].forEach(layout => {
                    const option = document.createElement('option');
                    option.value = layout.id;
                    option.textContent = layout.title;
                    option.dataset.imageUrl = layout.imageUrl;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            });
        }

        /* ---------------------------
        Display Sign Library
        --------------------------- */
        function loadSignLibrary(signs) {
            const signList = document.getElementById('signList');
            signList.innerHTML = '';

            if (!signs || signs.length === 0) {
                signList.innerHTML = '<div class="loading">No signs found</div>';
                document.getElementById('signTotal').textContent = 0;
                return;
            }

            document.getElementById('signTotal').textContent = signs.length;

            signs.forEach(sign => {
                const signDiv = document.createElement('div');
                signDiv.className = 'sign-item';
                signDiv.draggable = true;

                const img = document.createElement('img');
                img.alt = sign.id;
                img.src = sign.url || '';
                img.loading = 'lazy';

                img.onerror = function() {
                    if (sign.fileId) {
                        this.src = `https://drive.google.com/thumbnail?id=${sign.fileId}&sz=w200`;
                    } else {
                        this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="50" height="50"%3E%3Crect fill="%23f8fafc" width="50" height="50" stroke="%23cbd5e1"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23475569" dy=".3em" font-size="7"%3E' + encodeURIComponent(sign.id) + '%3C/text%3E%3C/svg%3E';
                    }
                };

                const infoDiv = document.createElement('div');
                infoDiv.className = 'sign-info';
                infoDiv.innerHTML = `<div class="sign-id">${escapeHtml(sign.id)}</div>
                                    <div class="sign-name">${escapeHtml(sign.name)}</div>
                                    ${sign.category ? `<div class="sign-category">${escapeHtml(sign.category)}</div>` : ''}`;

                signDiv.appendChild(img);
                signDiv.appendChild(infoDiv);

                signDiv.addEventListener('dragstart', (e) => {
                    draggedSign = sign;
                    try {
                        e.dataTransfer.setData('text/plain', JSON.stringify(sign));
                    } catch (err) { }
                    e.dataTransfer.effectAllowed = 'copy';
                });

                signList.appendChild(signDiv);
            });
        }

        /* ---------------------------
        Canvas Setup & Drag/Drop
        --------------------------- */
        function setupCanvas() {
            const canvas = document.getElementById('canvas');

            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
                canvas.classList.add('drag-over');
            });

            canvas.addEventListener('dragleave', (e) => {
                canvas.classList.remove('drag-over');
            });

            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                canvas.classList.remove('drag-over');

                let sign = null;
                try {
                    const raw = e.dataTransfer.getData('text/plain');
                    if (raw) {
                        const parsed = JSON.parse(raw);
                        if (parsed && parsed.id) sign = parsed;
                    }
                } catch (err) { }

                if (!sign) sign = draggedSign;
                if (!sign) return;

                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                addSign(sign, x, y);
                draggedSign = null;
            });

            document.getElementById('planSelect').addEventListener('change', updatePlan);

            document.getElementById('searchBox').addEventListener('input', (e) => {
                const q = e.target.value.trim().toLowerCase();
                const filtered = allSigns.filter(s =>
                    s.id.toLowerCase().includes(q) ||
                    s.name.toLowerCase().includes(q) ||
                    (s.category && s.category.toLowerCase().includes(q))
                );
                loadSignLibrary(filtered);
            });
        }

        /* ---------------------------
        Place Sign on Canvas
        --------------------------- */
        function addSign(sign, x, y) {
            const signId = Date.now() + Math.floor(Math.random()*1000);
            const signData = { ...sign, x, y, rotation: 0, uniqueId: signId };
            placedSigns.push(signData);
            renderSign(signData);
            updateCount();
            
            // Remove empty canvas message if present
            const emptyCanvas = document.getElementById('canvas').querySelector('.empty-canvas');
            if (emptyCanvas) emptyCanvas.remove();
        }

        /* ---------------------------
        Render Sign on Canvas
        --------------------------- */
        function renderSign(signData) {
            const canvas = document.getElementById('canvas');

            const signDiv = document.createElement('div');
            signDiv.className = 'placed-sign';
            signDiv.id = `sign-${signData.uniqueId}`;
            signDiv.style.left = `${signData.x}px`;
            signDiv.style.top = `${signData.y}px`;
            signDiv.style.transform = `translate(-50%,-50%) rotate(${signData.rotation}deg)`;

            const controls = document.createElement('div');
            controls.className = 'sign-controls';
            controls.innerHTML = `<button class="sign-btn btn-rotate" title="Rotate">‚Üª</button>
                                <button class="sign-btn btn-remove" title="Remove">√ó</button>`;

            const img = document.createElement('img');
            img.alt = signData.id;
            img.src = signData.url;
            img.onerror = function() {
                if (signData.fileId) this.src = `https://drive.google.com/thumbnail?id=${signData.fileId}&sz=w200`;
                else this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="70" height="70"%3E%3Crect fill="%23fef2f2" width="70" height="70" stroke="%23dc2626"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%23dc2626" dy=".3em" font-size="20"%3E‚ö†Ô∏è%3C/text%3E%3C/svg%3E';
            };

            const label = document.createElement('div');
            label.className = 'sign-label';
            label.textContent = signData.id;

            controls.querySelector('.btn-rotate').addEventListener('click', () => rotateSign(signData.uniqueId));
            controls.querySelector('.btn-remove').addEventListener('click', () => removeSign(signData.uniqueId));
            
            signDiv.appendChild(controls);
            signDiv.appendChild(img);
            signDiv.appendChild(label);

            let isDragging = false, startX=0, startY=0;

            signDiv.addEventListener('mousedown', (e) => {
                if (e.target.closest('.sign-btn')) return;
                isDragging = true;
                const rect = canvas.getBoundingClientRect();
                startX = e.clientX - rect.left - signData.x;
                startY = e.clientY - rect.top - signData.y;
                signDiv.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const rect = canvas.getBoundingClientRect();
                signData.x = e.clientX - rect.left - startX;
                signData.y = e.clientY - rect.top - startY;
                signDiv.style.left = `${signData.x}px`;
                signDiv.style.top = `${signData.y}px`;
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    signDiv.style.cursor = 'move';
                }
            });

            canvas.appendChild(signDiv);
        }

        /* ---------------------------
        Controls
        --------------------------- */
        function rotateSign(uniqueId) {
            const s = placedSigns.find(x => x.uniqueId === uniqueId);
            if (!s) return;
            s.rotation = (s.rotation + 90) % 360;
            const el = document.getElementById(`sign-${uniqueId}`);
            if (el) el.style.transform = `translate(-50%,-50%) rotate(${s.rotation}deg)`;
        }

        function removeSign(uniqueId) {
            placedSigns = placedSigns.filter(x => x.uniqueId !== uniqueId);
            const el = document.getElementById(`sign-${uniqueId}`);
            if (el) el.remove();
            updateCount();
        }

        function clearAll() {
            if (!confirm('Remove all placed signs?')) return;
            placedSigns.forEach(s => {
                const el = document.getElementById(`sign-${s.uniqueId}`);
                if (el) el.remove();
            });
            placedSigns = [];
            updateCount();
            showNotification('All signs cleared', 'info');
        }

        function updateCount() {
            document.getElementById('signCount').textContent = placedSigns.length;
        }

        function savePlan() {
            if (placedSigns.length === 0) {
                showNotification('Please add some signs to the plan first!', 'error');
                return;
            }
            
            const planSelect = document.getElementById('planSelect');
            if (!planSelect.value && !currentPlanImageUrl) {
                showNotification('Please select a traffic plan first!', 'error');
                return;
            }
            
            // Prepare export data
            const exportData = {
                planId: planSelect.value || 'custom',
                planImageUrl: currentPlanImageUrl || planSelect.options[planSelect.selectedIndex]?.dataset.imageUrl,
                signCount: placedSigns.length,
                signs: placedSigns.map(s => ({
                    id: s.id,
                    name: s.name,
                    x: s.x,
                    y: s.y,
                    rotation: s.rotation
                })),
                timestamp: new Date().toISOString()
            };
            
            console.log('Export Data:', exportData);
            showNotification(`Plan ready to export with ${placedSigns.length} signs positioned`, 'success');
            
            // In production, this would send data back to AppSheet or download as JSON
            // For now, we'll copy to clipboard
            navigator.clipboard.writeText(JSON.stringify(exportData, null, 2))
                .then(() => showNotification('Plan data copied to clipboard', 'success'))
                .catch(() => console.log('Could not copy to clipboard'));
        }

        /* ---------------------------
        Update Canvas Background
        --------------------------- */
        function updatePlan() {
            const select = document.getElementById('planSelect');
            const canvas = document.getElementById('canvas');
            
            if (select.value) {
                const selectedOption = select.options[select.selectedIndex];
                const imageUrl = selectedOption.dataset.imageUrl;
                
                if (imageUrl) {
                    canvas.style.backgroundImage = `url(${imageUrl})`;
                    currentPlanImageUrl = imageUrl;
                    console.log('Loaded plan:', selectedOption.textContent);
                    showNotification(`Loaded: ${selectedOption.textContent}`, 'success');
                    
                    const emptyCanvas = canvas.querySelector('.empty-canvas');
                    if (emptyCanvas) emptyCanvas.remove();
                } else {
                    canvas.style.backgroundImage = '';
                }
            } else {
                canvas.style.backgroundImage = '';
            }
        }

        /* ---------------------------
        Utility Functions
        --------------------------- */
        function escapeHtml(s) {
            if (!s) return '';
            return s.toString().replace(/[&<>"']/g, function (m) {
                return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m];
            });
        }

        /* ---------------------------
        Initialize Application
        --------------------------- */
        function init() {
            setupCanvas();
            loadFromGoogleSheets();
            console.log('EMG Traffic Plan Designer ready');
            console.log('URL Parameters:', getURLParams());
        }
        
        init();
    </script>
    </body>
</html>
